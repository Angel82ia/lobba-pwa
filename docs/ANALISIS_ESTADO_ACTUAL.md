# AN√ÅLISIS ESTADO ACTUAL - LOBBA PWA

## Fecha: 2025-10-14
## An√°lisis completo de estructura existente

---

## ‚úÖ 1. STRIPE - YA CONFIGURADO

### Archivos existentes:
- ‚úÖ `/backend/src/utils/stripe.js` - Utilidades Stripe
- ‚úÖ `/backend/.env.example` - Variables configuradas

### Funciones disponibles:
```javascript
// backend/src/utils/stripe.js
- createPaymentIntent()      ‚úÖ Pago simple
- confirmPaymentIntent()      ‚úÖ Confirmar pago
- createRefund()              ‚úÖ Reembolsos
- calculateCommission()       ‚úÖ Calcular comisi√≥n
```

### Variables configuradas:
```env
STRIPE_SECRET_KEY=sk_test_your_secret_key
STRIPE_WEBHOOK_SECRET=whsec_your_webhook_secret
```

### ‚ö†Ô∏è LO QUE FALTA EN STRIPE:
- ‚ùå **Split Payment (Stripe Connect)** - Para marketplace (3%/97%)
- ‚ùå Cuentas conectadas de salones
- ‚ùå `application_fee_amount` en pagos de servicios
- ‚ùå `transfer_data.destination` para enviar al sal√≥n

**CONCLUSI√ìN STRIPE:** Configurado para ecommerce (100% LOBBA), falta marketplace (split 3%/97%).

---

## ‚úÖ 2. ECOMMERCE - YA EXISTE (80% COMPLETADO)

### Tablas Base de Datos:
| Tabla | Archivo | Estado |
|-------|---------|--------|
| `product_categories` | `011_create_product_categories_table.sql` | ‚úÖ |
| `products` | `012_create_products_table.sql` | ‚úÖ |
| `product_variants` | `013_create_product_variants_table.sql` | ‚úÖ |
| `product_images` | `014_create_product_images_table.sql` | ‚úÖ |
| `carts` | `015_create_cart_and_orders_tables.sql` | ‚úÖ |
| `cart_items` | `015_create_cart_and_orders_tables.sql` | ‚úÖ |
| `orders` | `015_create_cart_and_orders_tables.sql` | ‚úÖ |
| `order_items` | `015_create_cart_and_orders_tables.sql` | ‚úÖ |

### Tabla Products - Ya tiene brand='LOBBA':
```sql
CREATE TABLE products (
  id UUID PRIMARY KEY,
  name VARCHAR(255) NOT NULL,
  slug VARCHAR(255) NOT NULL UNIQUE,
  description TEXT,
  brand VARCHAR(255) DEFAULT 'LOBBA',  ‚Üê ‚úÖ Ya tiene marca
  category_id UUID,
  base_price DECIMAL(10, 2),
  discount_percentage DECIMAL(5, 2) DEFAULT 0,
  stock_quantity INTEGER DEFAULT 0,
  is_new BOOLEAN DEFAULT false,
  is_featured BOOLEAN DEFAULT false,
  is_active BOOLEAN DEFAULT true
);
```

### Tabla Orders - Extendida para membres√≠as:
```sql
-- 049_extend_orders_for_memberships.sql (YA CREADA)
ALTER TABLE orders 
  ADD COLUMN membership_discount DECIMAL(10, 2) DEFAULT 0,
  ADD COLUMN membership_type VARCHAR(20),
  ADD COLUMN free_shipping BOOLEAN DEFAULT false;
```

### Modelos Backend:
- ‚úÖ `/backend/src/models/Product.js`
- ‚úÖ `/backend/src/models/ProductImage.js`
- ‚úÖ `/backend/src/models/Order.js`

### Componentes Frontend:
- ‚úÖ `/src/modules/ecommerce/ProductGrid.jsx`
- ‚úÖ `/src/modules/ecommerce/ProductDetail.jsx`
- ‚úÖ `/src/modules/ecommerce/Cart.jsx`
- ‚úÖ `/src/modules/ecommerce/CheckoutForm.jsx`
- ‚úÖ `/src/modules/ecommerce/Wishlist.jsx`

### ‚ö†Ô∏è LO QUE FALTA EN ECOMMERCE:
- ‚ùå Campo `seller` en tabla orders (para diferenciar origen)
- ‚ùå Campo `type` = 'product_order' en orders
- ‚ùå L√≥gica de descuentos membres√≠a en checkout (10% Essential, 15% Spirit)
- ‚ùå L√≥gica de env√≠o gratis (>30‚Ç¨ Essential, >15‚Ç¨ Spirit)
- ‚ùå Integraci√≥n Stripe completa en checkout

**CONCLUSI√ìN ECOMMERCE:** Casi terminado, solo falta integrar l√≥gica membres√≠as + Stripe.

---

## ‚úÖ 3. MARKETPLACE - YA EXISTE (70% COMPLETADO)

### Tablas Base de Datos:
| Tabla | Archivo | Estado |
|-------|---------|--------|
| `salon_profiles` | `004_create_salon_profiles_table.sql` | ‚úÖ |
| `salon_categories` | `005_create_salon_categories_table.sql` | ‚úÖ |
| `salon_services` | `006_create_salon_services_table.sql` | ‚úÖ |
| `salon_gallery` | `007_create_salon_gallery_table.sql` | ‚úÖ |
| `reservations` | `009_create_reservations_table.sql` | ‚úÖ |

### Tabla salon_profiles - Ya tiene geolocalizaci√≥n:
```sql
CREATE TABLE salon_profiles (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  business_name VARCHAR(255) NOT NULL,
  description TEXT,
  address TEXT,
  city VARCHAR(100),
  postal_code VARCHAR(20),
  phone VARCHAR(50),
  website TEXT,
  
  location GEOGRAPHY(Point, 4326),  ‚Üê ‚úÖ PostGIS para b√∫squeda cercana
  business_hours JSONB,             ‚Üê ‚úÖ Horarios din√°micos
  
  is_click_collect BOOLEAN DEFAULT false,
  accepts_reservations BOOLEAN DEFAULT true,
  
  rating DECIMAL(2, 1) DEFAULT 0.0,
  total_reviews INTEGER DEFAULT 0,
  
  is_active BOOLEAN DEFAULT true,
  verified BOOLEAN DEFAULT false
);
```

### Tabla salon_services - Ya tiene todo necesario:
```sql
CREATE TABLE salon_services (
  id UUID PRIMARY KEY,
  salon_profile_id UUID REFERENCES salon_profiles(id),
  category_id UUID,
  
  name VARCHAR(255) NOT NULL,       ‚Üê ‚úÖ 'Corte', 'Manicura'
  description TEXT,
  price DECIMAL(10, 2) NOT NULL,    ‚Üê ‚úÖ Precio servicio
  duration_minutes INTEGER NOT NULL, ‚Üê ‚úÖ Duraci√≥n
  
  discount_percentage INTEGER DEFAULT 0,
  is_active BOOLEAN DEFAULT true
);
```

### Tabla reservations - Ya completa:
```sql
CREATE TABLE reservations (
  id UUID PRIMARY KEY,
  user_id UUID REFERENCES users(id),
  salon_profile_id UUID REFERENCES salon_profiles(id),
  service_id UUID REFERENCES salon_services(id),
  
  start_time TIMESTAMP NOT NULL,
  end_time TIMESTAMP NOT NULL,
  buffer_minutes INTEGER DEFAULT 15,
  
  status VARCHAR(20),  -- 'pending', 'confirmed', 'completed', 'cancelled'
  
  deposit_paid BOOLEAN DEFAULT false,
  deposit_amount DECIMAL(10, 2),
  total_price DECIMAL(10, 2) NOT NULL,  ‚Üê ‚úÖ Precio total
  
  google_calendar_event_id VARCHAR(255)
);
```

### Modelos Backend:
- ‚úÖ `/backend/src/models/SalonProfile.js`
- ‚úÖ `/backend/src/models/SalonService.js`
- ‚úÖ `/backend/src/models/SalonCategory.js`
- ‚úÖ `/backend/src/models/SalonGallery.js`
- ‚úÖ `/backend/src/models/Reservation.js`

### Rutas Backend:
- ‚úÖ `/backend/src/routes/salon.js`
- ‚úÖ `/backend/src/routes/reservation.js`

### Componentes Frontend:
- ‚úÖ `/src/modules/salon/SalonList.jsx`
- ‚úÖ `/src/modules/salon/SalonProfile.jsx`
- ‚úÖ `/src/modules/salon/EditSalonProfile.jsx`
- ‚úÖ `/src/modules/reservations/ReservationCalendar.jsx`
- ‚úÖ `/src/modules/reservations/ReservationList.jsx`

### ‚ö†Ô∏è LO QUE FALTA EN MARKETPLACE:
- ‚ùå **Campos de comisi√≥n en tabla `reservations`:**
  ```sql
  commission_percentage DECIMAL(5, 2) DEFAULT 3.00,
  commission_amount DECIMAL(10, 2),
  amount_to_lobba DECIMAL(10, 2),
  amount_to_commerce DECIMAL(10, 2),
  payment_status VARCHAR(20)
  ```
- ‚ùå **Campo Stripe Connect en `salon_profiles`:**
  ```sql
  stripe_connect_account_id VARCHAR(255)
  ```
- ‚ùå **Split Payment Stripe** (3% LOBBA, 97% sal√≥n)
- ‚ùå Flujo de pago en checkout de servicios
- ‚ùå Webhook para confirmar reserva tras pago

**CONCLUSI√ìN MARKETPLACE:** Estructura completa, solo falta l√≥gica comisi√≥n + Stripe Connect.

---

## ‚úÖ 4. MEMBRES√çAS - EN PROGRESO (50% COMPLETADO)

### Tablas creadas (migraciones 040-050):
| Tabla | Archivo | Estado |
|-------|---------|--------|
| `memberships` | `040_create_memberships_table.sql` | ‚úÖ |
| `shared_memberships` | `041_create_shared_memberships_table.sql` | ‚úÖ |
| **Extensiones:** | `042_extend_memberships_table.sql` | ‚úÖ |
| - `billing_cycle` | 042 | ‚úÖ |
| - `is_free_month` | 042 | ‚úÖ |
| - `referral_code` | 042 | ‚úÖ |
| `monthly_limits` | `043_create_monthly_limits_table.sql` | ‚úÖ |
| `monthly_shipments` | `044_create_monthly_shipments_table.sql` | ‚úÖ |
| `powerbank_loans` | `045_create_powerbank_loans_table.sql` | ‚úÖ |
| `emergency_article_uses` | `046_create_emergency_article_uses_table.sql` | ‚úÖ |
| `referral_campaigns` | `047_create_referral_campaigns_table.sql` | ‚úÖ |
| Users extension | `048_extend_users_for_referrals.sql` | ‚úÖ |
| Orders extension | `049_extend_orders_for_memberships.sql` | ‚úÖ |
| Sync triggers | `050_create_sync_triggers.sql` | ‚úÖ |

### Componentes creados:
- ‚úÖ `/src/pages/Membership.jsx`
- ‚úÖ `/src/modules/membership/components/SharedMembershipForm.jsx`
- ‚úÖ `/src/modules/membership/components/SharedMembershipCard.jsx`
- ‚úÖ `/backend/src/models/SharedMembership.js`
- ‚úÖ `/backend/src/controllers/membershipController.js`
- ‚úÖ `/backend/src/routes/membership.js`

### ‚ö†Ô∏è LO QUE FALTA EN MEMBRES√çAS:
- ‚ùå FASES 2-7 del plan de implementaci√≥n
- ‚ùå Dashboard membres√≠a con l√≠mites mensuales
- ‚ùå L√≥gica powerbanks
- ‚ùå L√≥gica emergencias
- ‚ùå Sistema referidos completo
- ‚ùå Webhooks Stripe suscripciones

**CONCLUSI√ìN MEMBRES√çAS:** Fase 1 completada (estructura DB), faltan fases 2-7.

---

## ‚ùå 5. ERP (ODOO) - NO EXISTE

### Estado:
- ‚ùå No hay integraci√≥n ERP
- ‚ùå No hay middleware sincronizaci√≥n
- ‚ùå No hay c√≥digos internos productos
- ‚ùå No hay sincronizaci√≥n stock autom√°tica

### Documentos revisados:
- `/home/ubuntu/attachments/e5db77c3-d600-4dc0-b8f1-8456de77b16d/erp+lobba+productos++stripe.pdf`

### Lo que necesitar√≠a:
1. C√≥digos internos √∫nicos por producto
2. Middleware sincronizaci√≥n stock
3. Webhook ERP ‚Üí PWA cuando cambia stock
4. Validaci√≥n stock antes de venta

**CONCLUSI√ìN ERP:** Usuario dice "probable que lo dejemos para una segunda fase" ‚úÖ

---

## ‚ùå 6. CSV MASS IMPORT SALONES - NO EXISTE

### Estado:
- ‚ùå No hay endpoint mass import
- ‚ùå No hay validaci√≥n CSV
- ‚ùå No hay parser CSV ‚Üí DB

### Documentos revisados:
- `/home/ubuntu/attachments/0cfa146b-a655-477c-a622-ff7e27d2ba46/csv+negocios+y+guia+para+rellenado+ayuda..pdf`

### Lo que necesitar√≠a:
1. Template CSV con columnas exactas
2. Endpoint `/api/admin/salons/import-csv`
3. Validaci√≥n datos (coordenadas, tel√©fonos, etc.)
4. Procesamiento masivo (chunking)

**CONCLUSI√ìN CSV:** Pendiente de implementar cuando usuario lo pida.

---

## üìä RESUMEN ESTADO ACTUAL

### ‚úÖ LO QUE YA FUNCIONA:

**ECOMMERCE (80% COMPLETO):**
- ‚úÖ Base de datos products completa
- ‚úÖ Carrito de compra
- ‚úÖ Frontend product catalog
- ‚úÖ Stock management
- ‚ùå Falta: Integrar descuentos membres√≠a + Stripe checkout

**MARKETPLACE (70% COMPLETO):**
- ‚úÖ Base de datos salons completa
- ‚úÖ Servicios por sal√≥n
- ‚úÖ Sistema reservas
- ‚úÖ Frontend b√∫squeda salones
- ‚ùå Falta: Comisi√≥n 3%/97% + Stripe Connect

**MEMBRES√çAS (50% COMPLETO):**
- ‚úÖ Estructura DB completa (10 migraciones)
- ‚úÖ Componentes compartir membres√≠a
- ‚ùå Falta: Fases 2-7 (dashboard, l√≠mites, powerbanks, etc.)

**STRIPE:**
- ‚úÖ Configurado b√°sico
- ‚ùå Falta: Stripe Connect (marketplace)

### ‚ùå LO QUE NO EXISTE:

1. **ERP (Odoo)** - Segunda fase seg√∫n usuario
2. **CSV Mass Import** - Pendiente
3. **Split Payment Marketplace** - Necesario
4. **Descuentos autom√°ticos membres√≠a** - Necesario
5. **Dashboard membres√≠as cliente** - Necesario

---

## üîÑ COMPARACI√ìN CON DOCUMENTOS

### Documento: "flujo de ecomerce- negocios.pdf"

**‚úÖ CORRECTO EN PROYECTO ACTUAL:**
- ‚úÖ Productos LOBBA separados de salones
- ‚úÖ Servicios en salones (no productos)
- ‚úÖ `brand = 'LOBBA'` en tabla products
- ‚úÖ Reservations solo para servicios

**‚ùå FALTA IMPLEMENTAR:**
- ‚ùå Tabla `orders.seller` = 'LOBBA' (para distinguir)
- ‚ùå Tabla `reservations` campos comisi√≥n
- ‚ùå Stripe Split Payment

### Documento: "membresias tecnico.pdf"

**‚úÖ YA IMPLEMENTADO:**
- ‚úÖ Membres√≠a Essential / Spirit
- ‚úÖ Compartir membres√≠a (max 5)
- ‚úÖ Billing cycle, free month
- ‚úÖ Tablas l√≠mites mensuales

**‚ùå FALTA IMPLEMENTAR:**
- ‚ùå UI Dashboard membres√≠a
- ‚ùå L√≥gica powerbanks
- ‚ùå L√≥gica emergencias
- ‚ùå Aplicar descuentos en checkout

### Documento: "erp+lobba+productos+stripe.pdf"

**‚ùå NO IMPLEMENTADO:**
- ‚ùå Integraci√≥n ERP (segunda fase)
- ‚ùå C√≥digos internos productos
- ‚ùå Sincronizaci√≥n stock autom√°tica

### Documento: "csv+negocios.pdf"

**‚ùå NO IMPLEMENTADO:**
- ‚ùå Endpoint import CSV
- ‚ùå Validaci√≥n masiva
- ‚ùå Parser CSV

---

## üéØ PRIORIDADES SEG√öN DOCUMENTOS

### ALTA PRIORIDAD (Necesario para funcionamiento):

**1. ECOMMERCE - Completar integraci√≥n:**
- [ ] Campo `orders.seller` = 'LOBBA'
- [ ] Campo `orders.type` = 'product_order'
- [ ] L√≥gica descuento membres√≠a en checkout (10%/15%)
- [ ] L√≥gica env√≠o gratis (>30‚Ç¨ Essential, >15‚Ç¨ Spirit)
- [ ] Integrar Stripe en ProductCheckout

**2. MARKETPLACE - Agregar comisiones:**
- [ ] Migraci√≥n: Extender `reservations` con campos comisi√≥n
- [ ] Migraci√≥n: Campo `stripe_connect_account_id` en `salon_profiles`
- [ ] Implementar Split Payment Stripe Connect
- [ ] Checkout servicios con pago (3%/97%)

**3. MEMBRES√çAS - Dashboard cliente:**
- [ ] UI Dashboard membres√≠a
- [ ] Mostrar l√≠mites mensuales
- [ ] Tracking env√≠os mensuales
- [ ] Gesti√≥n powerbanks

### MEDIA PRIORIDAD:

**4. CSV IMPORT SALONES:**
- [ ] Endpoint `/api/admin/salons/import-csv`
- [ ] Validaci√≥n CSV
- [ ] Parser y procesamiento masivo

**5. STRIPE WEBHOOKS:**
- [ ] Webhook suscripciones membres√≠as
- [ ] Webhook pagos marketplace
- [ ] Sincronizaci√≥n autom√°tica estados

### BAJA PRIORIDAD (Segunda fase):

**6. ERP (ODOO):**
- [ ] Integraci√≥n middleware
- [ ] Sincronizaci√≥n stock
- [ ] C√≥digos internos

---

## üìã ARQUITECTURA M√ìDULOS ACTUAL

```
lobba-pwa/
‚îú‚îÄ‚îÄ src/
‚îÇ   ‚îî‚îÄ‚îÄ modules/
‚îÇ       ‚îú‚îÄ‚îÄ ecommerce/          ‚Üê ‚úÖ 80% completo
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ProductGrid.jsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ProductDetail.jsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ Cart.jsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ CheckoutForm.jsx  ‚Üê ‚ùå Falta Stripe + membres√≠as
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ Wishlist.jsx
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ salon/              ‚Üê ‚úÖ 70% completo
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SalonList.jsx
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ SalonProfile.jsx
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ EditSalonProfile.jsx
‚îÇ       ‚îÇ
‚îÇ       ‚îú‚îÄ‚îÄ reservations/       ‚Üê ‚úÖ 70% completo
‚îÇ       ‚îÇ   ‚îú‚îÄ‚îÄ ReservationCalendar.jsx
‚îÇ       ‚îÇ   ‚îî‚îÄ‚îÄ ReservationList.jsx  ‚Üê ‚ùå Falta checkout pago
‚îÇ       ‚îÇ
‚îÇ       ‚îî‚îÄ‚îÄ membership/         ‚Üê ‚ö†Ô∏è 50% completo
‚îÇ           ‚îî‚îÄ‚îÄ components/
‚îÇ               ‚îú‚îÄ‚îÄ SharedMembershipForm.jsx  ‚úÖ
‚îÇ               ‚îî‚îÄ‚îÄ SharedMembershipCard.jsx  ‚úÖ
‚îÇ               ‚îî‚îÄ‚îÄ MembershipDashboard.jsx   ‚ùå NO EXISTE
‚îÇ
‚îî‚îÄ‚îÄ backend/
    ‚îú‚îÄ‚îÄ database/migrations/
    ‚îÇ   ‚îú‚îÄ‚îÄ 011-015_*          ‚Üê ‚úÖ Ecommerce
    ‚îÇ   ‚îú‚îÄ‚îÄ 004-009_*          ‚Üê ‚úÖ Marketplace
    ‚îÇ   ‚îî‚îÄ‚îÄ 040-050_*          ‚Üê ‚úÖ Membres√≠as
    ‚îÇ
    ‚îú‚îÄ‚îÄ src/
    ‚îÇ   ‚îú‚îÄ‚îÄ models/
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Product.js     ‚úÖ
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ Order.js       ‚úÖ
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SalonProfile.js ‚úÖ
    ‚îÇ   ‚îÇ   ‚îú‚îÄ‚îÄ SalonService.js ‚úÖ
    ‚îÇ   ‚îÇ   ‚îî‚îÄ‚îÄ Reservation.js ‚úÖ (falta comisi√≥n)
    ‚îÇ   ‚îÇ
    ‚îÇ   ‚îî‚îÄ‚îÄ utils/
    ‚îÇ       ‚îî‚îÄ‚îÄ stripe.js      ‚ö†Ô∏è (falta Split Payment)
```

---

## ‚úÖ CONCLUSIONES FINALES

### 1. **Stripe:** YA CONFIGURADO
- ‚úÖ B√°sico funciona
- ‚ùå Falta Stripe Connect para marketplace

### 2. **ERP (Odoo):** NO, SEGUNDA FASE ‚úÖ
- Usuario confirma: "probable que lo dejemos para una segunda fase"

### 3. **Ecommerce:** NO DUPLICADO ‚úÖ
- Ya existe completo (80%)
- Solo falta integrar membres√≠as + Stripe

### 4. **Marketplace:** NO DUPLICADO ‚úÖ
- Ya existe completo (70%)
- Solo falta comisiones + Stripe Connect

### 5. **NO HAY CONFLICTOS** ‚úÖ
- Productos = Solo LOBBA ‚úÖ
- Servicios = Solo salones ‚úÖ
- Separaci√≥n clara ‚úÖ

---

## üöÄ PR√ìXIMOS PASOS RECOMENDADOS

### Opci√≥n A: Completar Ecommerce (m√°s r√°pido)
1. Extender orders (seller, type)
2. Integrar descuentos membres√≠a en checkout
3. Integrar Stripe en checkout productos
4. L√≥gica env√≠o gratis

### Opci√≥n B: Completar Marketplace (m√°s valor)
1. Extender reservations (comisiones)
2. Stripe Connect accounts
3. Split Payment implementaci√≥n
4. Checkout servicios con pago

### Opci√≥n C: Completar Membres√≠as (m√°s complejo)
1. Dashboard membres√≠a
2. L√≠mites mensuales UI
3. Powerbanks l√≥gica
4. Emergencias l√≥gica

---

**RECOMENDACI√ìN:** Empezar por **Opci√≥n A** (Ecommerce) porque:
- ‚úÖ M√°s r√°pido (menos cambios)
- ‚úÖ Genera ingresos directos
- ‚úÖ No requiere Stripe Connect
- ‚úÖ Permite testear flujo completo

Luego **Opci√≥n B** (Marketplace) y finalmente **Opci√≥n C** (Membres√≠as dashboard).

---

**Fecha:** 2025-10-14  
**An√°lisis:** Completo ‚úÖ  
**Conflictos:** Ninguno ‚úÖ  
**Listo para implementar:** S√≠ ‚úÖ
